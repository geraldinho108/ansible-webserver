#Ansible Azure Pipeline

trigger:
 - master

pool:
   name: 'default'

steps:

 - script: |
     echo "First pipeline script"
     echo "Another line of code"

 - script: |
     sudo apt-get  update  -y
     sudo apt install -y ansible
     ansible --version
   displayName: 'Installing Ansible'

 - script: |
     sudo apt-get update -y
     sudo apt-get install -y ansible-lint
     ansible-lint --version
   displayName: 'Installing Ansible lint'

 - task: Bash@3
   inputs:
     targetType: 'inline'
     script: 'ansible-lint'
     workingDirectory: '$(Build.SourcesDirectory)/playbooks'
   displayName: "Execute Ansible lint"

 - script: ANSIBLE_HOST_KEY_CHECKING=False ansible-playbook -u ubuntu -i ./host_inventory ./playbooks/apache-install.yml --private-key /home/ubuntu/.ssh/vm-instance-key.pem
   displayName: 'Installing Apache'

#This script will run the website-update.yml playbook.
 - script: ANSIBLE_HOST_KEY_CHECKING=False export ANSIBLE_ROLES_PATH=./roles && ansible-playbook -u ubuntu -i ./host_inventory ./playbooks/website-update.yml --private-key /home/ubuntu/.ssh/vm-instance-key.pem
   displayName: 'Running Website-Update'

#This script will run the website-test.yml playbook.
 - script: ANSIBLE_HOST_KEY_CHECKING=False export ANSIBLE_ROLES_PATH=./roles && ansible-playbook -u ubuntu -i ./host_inventory ./playbooks/website-test.yml --private-key /home/ubuntu/.ssh/vm-instance-key.pem
   displayName: 'Running Website-Test'   
